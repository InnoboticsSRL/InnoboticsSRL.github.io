

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibt_ros2_driver &mdash; ComboFox 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=ec3804ef" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=73cda6fb"></script>
      <script src="../../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html">
            
              <img src="../../../../_static/logo-IBT_positivo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile_base.html">Mobile Robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manipulator.html">Manipulator</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ComboFox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">ibt_ros2_driver</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/pages/features/pkgs/ibt_ros2_driver/ibt_ros2_driver.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ibt-ros2-driver">
<h1>ibt_ros2_driver<a class="headerlink" href="#ibt-ros2-driver" title="Permalink to this heading"></a></h1>
<p>For controlling the movement of the robotic arm, a ROS2 package has been developed that interfaces with the Motorcortex web server. Within this package, an action server has been primarily implemented, whose task is to receive and manage movement requests from a user, executing them in a safe and reliable manner</p>
<section id="general-objectives-of-the-project">
<h2>General Objectives of the Project<a class="headerlink" href="#general-objectives-of-the-project" title="Permalink to this heading"></a></h2>
<p>This section describes the main goals of the project at a conceptual level, without going into specific software implementation details.</p>
<p>The objective of the project is to develop a controller capable of receiving commands from a user to move a robotic arm, while ensuring the internal consistency of the system’s states. The controller provides the following functionalities:</p>
<ol class="arabic simple">
<li><p><strong>Joint coupling and error recovery</strong><br />
This functionality allows the user to couple the joints of the robot, an operation required to enable movement commands. It also makes it possible to bring the system back to an operational state in the event of execution errors.</p></li>
<li><p><strong>Canceling an ongoing operation</strong><br />
For safety or operational reasons, the user must be able to interrupt a movement currently in progress. The controller correctly handles the cancellation of the request.</p></li>
<li><p><strong>Publishing the robot’s status</strong><br />
The system provides in real time:</p>
<ul class="simple">
<li><p>The current positions of the robotic arm joints</p></li>
<li><p>The current status of the robot, according to its internal state machine</p></li>
</ul>
</li>
<li><p><strong>Movement execution</strong><br />
The controller supports various types of movement:</p>
<ul class="simple">
<li><p><strong>Joint Movement</strong>: Movement is executed by specifying a list of coordinates in joint space.</p></li>
<li><p><strong>Point-To-Point (P2P) Movement</strong>: The tool at the end of the arm reaches a specific position in Cartesian space.</p></li>
<li><p><strong>Linear Movement</strong>: The tool moves along a linear trajectory between two points in space.</p></li>
</ul>
</li>
<li><p><strong>Changing the dout state state</strong></p></li>
<li><p><strong>Publishing joint space positions and internal state of the arm</strong></p></li>
</ol>
</section>
<section id="how-to-use-the-package">
<h2>How to Use the Package<a class="headerlink" href="#how-to-use-the-package" title="Permalink to this heading"></a></h2>
<p>This package provides interfaces to control a robotic arm. The main functionalities include:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/robofox/ibt_ros2_driver
<span class="w">  </span>Subscribers:

<span class="w">  </span>Publishers:
<span class="w">    </span>/parameter_events:<span class="w"> </span>rcl_interfaces/msg/ParameterEvent
<span class="w">    </span>/robofox/eef_pose:<span class="w"> </span>ibt_ros2_interfaces/msg/PoseRPY
<span class="w">    </span>/robofox/joint_states:<span class="w"> </span>sensor_msgs/msg/JointState
<span class="w">    </span>/robofox/logic_state:<span class="w"> </span>std_msgs/msg/String
<span class="w">    </span>/rosout:<span class="w"> </span>rcl_interfaces/msg/Log
<span class="w">  </span>Service<span class="w"> </span>Servers:
<span class="w">    </span>/robofox/disarm:<span class="w"> </span>std_srvs/srv/Trigger
<span class="w">    </span>/robofox/ibt_ros2_driver/describe_parameters:<span class="w"> </span>rcl_interfaces/srv/DescribeParameters
<span class="w">    </span>/robofox/ibt_ros2_driver/get_parameter_types:<span class="w"> </span>rcl_interfaces/srv/GetParameterTypes
<span class="w">    </span>/robofox/ibt_ros2_driver/get_parameters:<span class="w"> </span>rcl_interfaces/srv/GetParameters
<span class="w">    </span>/robofox/ibt_ros2_driver/list_parameters:<span class="w"> </span>rcl_interfaces/srv/ListParameters
<span class="w">    </span>/robofox/ibt_ros2_driver/set_parameters:<span class="w"> </span>rcl_interfaces/srv/SetParameters
<span class="w">    </span>/robofox/ibt_ros2_driver/set_parameters_atomically:<span class="w"> </span>rcl_interfaces/srv/SetParametersAtomically
<span class="w">    </span>/robofox/rearm:<span class="w"> </span>std_srvs/srv/Trigger
<span class="w">    </span>/robofox/set_output:<span class="w"> </span>ibt_ros2_interfaces/srv/SetOutput
<span class="w">  </span>Service<span class="w"> </span>Clients:

<span class="w">  </span>Action<span class="w"> </span>Servers:
<span class="w">    </span>/robofox/move_arm:<span class="w"> </span>ibt_ros2_interfaces/action/MoveArm
<span class="w">  </span>Action<span class="w"> </span>Clients:
</pre></div>
</div>
</section>
<section id="moving-the-arm">
<h2>Moving the Arm<a class="headerlink" href="#moving-the-arm" title="Permalink to this heading"></a></h2>
<p>To send commands to the move_arm action server, it is recommended to write a ROS 2 client. Below is a practical example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rclpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.action</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionClient</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">std_srvs.srv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trigger</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ibt_ros2_interfaces.action</span><span class="w"> </span><span class="kn">import</span> <span class="n">MoveArm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibt_ros2_interfaces.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">MoveReq</span><span class="p">,</span> <span class="n">PoseRPY</span><span class="p">,</span> <span class="n">Waypoint</span>


<span class="n">RED</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span>
<span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span>
<span class="n">YELLOW</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span>
<span class="n">RESET</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TESTMove</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;test_move_arm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1">Starting TESTMove...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rearm_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">Trigger</span><span class="p">,</span> <span class="s1">&#39;/robofox/rearm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disarm_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">Trigger</span><span class="p">,</span> <span class="s1">&#39;/robofox/disarm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_client</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MoveArm</span><span class="p">,</span> <span class="s1">&#39;/robofox/move_arm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span> <span class="o">=</span> <span class="mf">60.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wp_home</span> <span class="o">=</span> <span class="n">Waypoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_home</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">90.0</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">90.0</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_home</span><span class="o">.</span><span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_home</span><span class="o">.</span><span class="n">next_segment_velocity_factor</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="o">.</span><span class="n">JOINT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">rotational_velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">rotational_acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wp_home</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wp_default</span> <span class="o">=</span> <span class="n">Waypoint</span><span class="p">()</span>
        <span class="c1"># in joint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_default</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.361</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.578</span><span class="p">,</span> <span class="mf">1.607</span><span class="p">,</span> <span class="mf">0.038</span><span class="p">,</span> <span class="mf">0.384</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_default</span><span class="o">.</span><span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp_default</span><span class="o">.</span><span class="n">next_segment_velocity_factor</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req_default</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_default</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="o">.</span><span class="n">JOINT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">rotational_velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="o">.</span><span class="n">rotational_acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_default</span><span class="o">.</span><span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wp_default</span><span class="p">]</span>

        <span class="c1"># Detection poses in xyzRPY format wrt base_link</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_poses</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.60</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">180</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">180</span><span class="p">)]</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_rearm_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rearm_client</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Rearm service not available.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">Trigger</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rearm_client</span><span class="o">.</span><span class="n">call_async</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">GREEN</span><span class="si">}</span><span class="s1">Rearm service called successfully.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Timeout of 5 seconds after rearm to ensure the arm is ready</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Failed to call rearm service.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_disarm_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disarm_client</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Disarm service not available.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">Trigger</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disarm_client</span><span class="o">.</span><span class="n">call_async</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">GREEN</span><span class="si">}</span><span class="s1">Disarm service called successfully.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Timeout of 1 second after disarm to ensure the arm is not engaged</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Failed to call disarm service.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_pose_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_vector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoseRPY</span><span class="p">:</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">PoseRPY</span><span class="p">()</span>
        <span class="n">pose</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">pose</span><span class="o">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">pose_vector</span>
        <span class="k">return</span> <span class="n">pose</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">feedback_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback_msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1"> Feedback: </span><span class="si">{</span><span class="n">feedback_msg</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">status</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_to_req_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">MoveReq</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s1"> [Trying to move to home pose...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">goal_msg</span> <span class="o">=</span> <span class="n">MoveArm</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
        <span class="n">goal_msg</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span><span class="p">]</span>

        <span class="c1"># First way to send MoveArm goal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s1">Sending goal: </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">move_type</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_client</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal_msg</span><span class="p">,</span> <span class="n">feedback_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_callback</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">goal_handle</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal_handle</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Goal was rejected or failed to send.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s1">Goal accepted, waiting for result...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">result_future</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_result_async</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1">Move result: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="si">}</span><span class="s1"> (Code: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">move_to_pose_rpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpy</span><span class="p">:</span> <span class="n">PoseRPY</span><span class="p">):</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="n">MoveArm</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>

        <span class="n">wp</span> <span class="o">=</span> <span class="n">Waypoint</span><span class="p">()</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpy</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rpy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">rpy</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">rpy</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span> <span class="n">rpy</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">rpy</span><span class="o">.</span><span class="n">yaw</span><span class="p">]</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">next_segment_velocity_factor</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">move_type</span> <span class="o">=</span> <span class="n">MoveReq</span><span class="o">.</span><span class="n">PTP</span>
        <span class="n">req</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">req</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">req</span><span class="o">.</span><span class="n">rotational_velocity</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">req</span><span class="o">.</span><span class="n">rotational_acceleration</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">req</span><span class="o">.</span><span class="n">waypoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="p">]</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s1">Sending goal: </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">move_type</span><span class="si">}{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_client</span><span class="o">.</span><span class="n">send_goal_async</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="n">feedback_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback_callback</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">goal_handle</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal_handle</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Goal was rejected or failed to send.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BLUE</span><span class="si">}</span><span class="s1">Goal accepted, waiting for result...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">result_future</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_result_async</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_until_future_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_future</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1">Move result: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="si">}</span><span class="s1"> (Code: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">### Pipeline simplified to just move the arm ###</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_rearm_service</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Rearm service call failed. Exiting...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1"> Waiting for action servers...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">GREEN</span><span class="si">}</span><span class="s1"> Move arm server active...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_req_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_default</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Pipeline aborted: failed to reach default pose.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_req_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_home</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Pipeline aborted: failed to reach home pose.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

            
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pose_vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detection_poses</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">YELLOW</span><span class="si">}</span><span class="s1"> [Try </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">] Moving to detection pose...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_pose_rpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_pose_msg</span><span class="p">(</span><span class="n">pose_vec</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Failed to move to detection pose </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Exiting...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_disarm_service</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">Disarm service call failed. Exiting...</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">TESTMove</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">execute_pipeline</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RED</span><span class="si">}</span><span class="s1">TESTMove interrupted by user.</span><span class="si">{</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Innobotics.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>